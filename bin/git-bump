#!/bin/bash

# this script will display the current version, automatically
# suggest a "minor" version update, and ask for input to use
# the suggestion, or a newly entered value.

# once the new version number is determined, the script will
# pull a list of changes from git history, prepend this to
# a file called CHANGELOG.md (under the title of the new version
# number), give user a chance to review and update the changelist
# manually if needed and create a GIT tag.

#git script variables
SUBDIRECTORY_OK="yes"
NONGIT_OK="yes"
source $(git stats --script-location $0)/git-bump-common

load_settings(){
  local root_path
  if gadgets_is_initialized; then
    root_path=$(git stats --root-path)
  else
    root_path=$(pwd)
  fi

  gadgets_load_settings
  export TEMP_FILE=$root_path/tmpfile
  if gadgets_is_initialized; then
    export VERSION_FILE=$root_path/$(git_get bump.path.version)
    export CHANGELOG_FILE=$root_path/$(git_get bump.path.changelog)
  fi
}

if equals "$1" "init" || equals "$1" "version" || equals "$1" "tag" equals "$1" "revert-to"; then
  flow="$1"; shift;
else
  flow="version"
fi

load_settings

BUMP_FILE=$(location $0)/git-bump-$flow
if [[ -e $BUMP_FILE ]]; then
  if [[ ! -x $BUMP_FILE ]]; then
    sudo chmod +x $BUMP_FILE
  fi

  if ! gadgets_bump_is_initialized && [ "$flow" != "init" ]; then
    die "Bump is not initialized. Please execute 'git bump init' to start setup."
  fi
  #Run flow
  . $BUMP_FILE
  "${action:-"default"}" "$@"
else
  usage
fi
